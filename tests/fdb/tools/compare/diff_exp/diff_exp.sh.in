#!/usr/bin/env bash

set -eux

yell() { printf "$(basename "$0"): \033[0;31m!!! %s !!!\033[0m\\n" "$*" >&2; }
die() { yell "$*"; exit 1; }
try() { "$@" || die "Errored HERE => '$*'"; }


fdbread="$<TARGET_FILE:fdb-read>"
fdbwrite="$<TARGET_FILE:fdb-write>"
fdblist="$<TARGET_FILE:fdb-list>"
fdbcompare="$<TARGET_FILE:fdb-compare>"

gribls="$<TARGET_FILE:grib_ls>"
gribset="$<TARGET_FILE:grib_set>"


srcdir=@CMAKE_CURRENT_SOURCE_DIR@
bindir=@CMAKE_CURRENT_BINARY_DIR@
wdir=$bindir/diff_exp

### cleanup and prepare test

rm -rf $bindir/grib
mkdir -p $bindir/grib

rm -rf $bindir/ref-root
mkdir ref-root

rm -rf $bindir/test-root
mkdir test-root

for f in ref.yaml test.yaml schema ../data.grib
do
    cp $srcdir/$f $bindir
done


$gribset -s edition=2 data.grib data2.grib
$gribset -s step=6 data2.grib grib/6.grib
$gribset -s step=9 data2.grib grib/9.grib
$gribset -s type=an grib/6.grib grib/an6.grib
$gribset -s type=an grib/9.grib grib/an9.grib

$fdbwrite --config=ref.yaml grib/6.grib
$fdbwrite --config=ref.yaml grib/9.grib
$fdbwrite --config=ref.yaml grib/an6.grib
$fdbwrite --config=ref.yaml grib/an9.grib


# #Different comparisons: 
# # compare the reference fdb with itself => bitidentical
# $fdbwrite --config=test.yaml grib/6.grib
# $fdbwrite --config=test.yaml grib/9.grib
# $fdbwrite --config=test.yaml grib/an6.grib
# $fdbwrite --config=test.yaml grib/an9.grib


$gribset -s expver=abcd,class=od grib/6.grib grib/6_ref.grib
$gribset -s expver=abcd,class=od grib/9.grib grib/9_ref.grib
$gribset -s expver=abcd,class=od grib/an6.grib grib/an6_ref.grib
$gribset -s expver=abcd,class=od grib/an9.grib grib/an9_ref.grib

$fdbwrite --config=test.yaml grib/6_ref.grib
$fdbwrite --config=test.yaml grib/9_ref.grib
$fdbwrite --config=test.yaml grib/an6_ref.grib
$fdbwrite --config=test.yaml grib/an9_ref.grib

$gribset -s expver=1234,class=rd grib/6.grib grib/6_dec.grib
$gribset -s expver=1234,class=rd grib/9.grib grib/9_dec.grib
$gribset -s expver=1234,class=rd grib/an6.grib grib/an6_dec.grib
$gribset -s expver=1234,class=rd grib/an9.grib grib/an9_dec.grib

$fdbwrite --config=test.yaml grib/6_dec.grib
$fdbwrite --config=test.yaml grib/9_dec.grib
$fdbwrite --config=test.yaml grib/an6_dec.grib
$fdbwrite --config=test.yaml grib/an9_dec.grib



set +e

# The only applicable grib-comparison-method for expected metadata changes is grib-keys
$fdbcompare --config=test.yaml --reference-request="class=od,expver=abcd" --test-request="class=rd,expver=1234"  --grib-comparison-type="grib-keys" | tee out
tool_rc=${PIPESTATUS[0]}

grep -Fq "[MARS KEYS COMPARE] SUCCESS" out 
grep_rc=$?

if [ $tool_rc -ne 0 ] || [ $grep_rc -ne 0 ]; then
    die "Mars Key check failed although the fdbs should be identical (tool_rc=$tool_rc, grep_rc=$grep_rc)"
fi

#####


$fdbcompare --config=test.yaml --reference-request="class=od,expver=abcd" --test-request="class=rd,expver=1234" --scope=header-only --grib-comparison-type="grib-keys" | tee out
tool_rc=${PIPESTATUS[0]}

! grep -Fq "GRIB COMPARISON MISMATCH" out 
grep_rc=$?

if [ $tool_rc -ne 0 ] || [ $grep_rc -ne 0 ]; then
    die "Grib Comparison check failed although grib messages should be identical (tool_rc=$tool_rc, grep_rc=$grep_rc)"
fi


#####

$fdbcompare --config=test.yaml --reference-request="class=od,expver=abcd" --test-request="class=rd,expver=1234" --scope=all  --grib-comparison-type="grib-keys" | tee out
tool_rc=${PIPESTATUS[0]}

grep -Fq "SUCCESS" out
grep_rc=$?

if [ $tool_rc -ne 0 ] || [ $grep_rc -ne 0 ]; then
die "Mars Key check failed although the fdbs should be identical (tool_rc=$tool_rc, grep_rc=$grep_rc)"
fi
