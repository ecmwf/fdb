#!/usr/bin/env bash

set -eux

fdbread="$<TARGET_FILE:fdb-read>"
fdbwrite="$<TARGET_FILE:fdb-write>"
fdblist="$<TARGET_FILE:fdb-list>"
fdbdumptoc="$<TARGET_FILE:fdb-dump-toc>"

gribls="$<TARGET_FILE:grib_ls>"
gribset="$<TARGET_FILE:grib_set>"

srcdir=@CMAKE_CURRENT_SOURCE_DIR@
bindir=@CMAKE_CURRENT_BINARY_DIR@
wdir=$bindir/FDB-535

### cleanup and prepare test

rm -rf $bindir/localroot
mkdir localroot

for f in config.yaml schema x.grib req.mars
do
    cp $srcdir/$f $bindir
done

export FDB5_CONFIG_FILE=config.yaml

FDB_INDEX_TYPE=BTreeIndex64 $fdbwrite x.grib

$fdbdumptoc localroot/od:g/toc | tee out
if grep -q BTreeIndex64 out; then
    echo BTreeIndex64 found
else
    exit 1
fi

$fdbread req.mars out.grib

cat out.grib
cat x.grib
cmp out.grib x.grib