#!/usr/bin/env bash

set -eux

fdbread="$<TARGET_FILE:fdb-read>"
fdbwrite="$<TARGET_FILE:fdb-write>"
fdblist="$<TARGET_FILE:fdb-list>"

gribls="$<TARGET_FILE:grib_ls>"
gribset="$<TARGET_FILE:grib_set>"

srcdir=@CMAKE_CURRENT_SOURCE_DIR@
bindir=@CMAKE_CURRENT_BINARY_DIR@
wdir=$bindir/FDB-535

### cleanup and prepare test

rm -rf $bindir/localroot
mkdir localroot

for f in config.yaml schema x.grib req.mars
do
    cp $srcdir/$f $bindir
done

export FDB5_CONFIG_FILE=config.yaml

FDB5_SERIALISATION_VERSION=4 $fdbwrite x.grib

FDB5_SERIALISATION_VERSION=4 $fdbread req.mars out.grib

cat out.grib
cat x.grib
cmp out.grib x.grib